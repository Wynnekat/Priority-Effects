---
title: "Priority Effects"
author: K. Carter Wynne
output: 
  html_document:
    smart: no
    theme: flatly
    float: yes
    css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
---




```{r}
# PROLOG   ##############################################################################

# PROJECT: Priority Effects Experiment 
# PURPOSE: Determine how species arrival via seed additions affects the community assembly of restored prairie plant communities
#
# AUTHOR:  Katherine Wynne (Wynnekat@msu.edu)
# COLLAB:  L. Sullivan
# CREATED: 06 December 2022
#
# FILES:   1) inner_cover_summer_2022.xlsx - vegetative cover taken in the Summer (end of June)
#          2) inner_cover_fall _2022.xlsx - vegetative cover taken at peak biomass (end ofAugust)
#          3) Checklist of Missouri Flora.xlsx - contains the information about all plants found in MO
#          4) Cleaned_PE_Detailed_Species_List_2022.xlsx - dataset containing the information about only                                                                plants found in the study
#         
#LAST UPDATED: 06 September 2023
# PROLOG   ##############################################################################
```

## Treatment information & Setup {.tabset}

NON = None (no species seeded)

SIM = Simulataneous (36 species seeded on March 22nd, 2021)

LE = Lumped early (18 early-dispersing species seeded on March 23rd, 2021 then 18 late-dispersing species seeded on September 5th, 2021)

LL = Lumped late (18 late-dispersing species seeded on March 23rd, 2021 then 18 early-dispersing species seeded on September 5th, 2021)

NAT = Natural; species added according to peak dispersal date

        - May 24th 2021 (VIOPED, PACPLA)
        - June 4th 2021 (SISCAM, SPHOBT, CORLAN)
        - June 22nd 2021 (LOBSPI, TRAOHI, CARBUS, HEURIC)
        - July 11th 2021 (CORPAL, DODMEA)
        - July 25th 2021 (KOEMAC, AMOCAN)
        - August 2nd 2021 (LINSUL, MELVIR)
        - August 21st 2021 (DALCAN, DALPUR, ACHMIL)
        - September 17th 2021 (CROSAG)
        - October 4th 2021 (CHAFAS, MONFIS, RATPIN, SPOHET, RUDHIR)
        - October 18th 2021 (BIDARI, HELMOL, LESCAP)
        - November 1st 2021 (PENDIG, ERYYUC, HYPPUN, SORNUT, SCHSCO, LIAPYC)
        - November 19th 2021 (CORTRI, PYCTEN, SOLRIG)
      
### Load libraries {.tabset}

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

## Libraries


# Import excel files
library(readxl)

# Data cleaning and visualization
library(tidyverse)

# Community ecology functions (NMDS, diversity indices, etc.)
library(vegan)

# Export dataframes to excel files
library(writexl)

# Dimensions check for NMDS stress
library(goeveg)

# Function for pairwise PERMANOVA tests

library(pairwiseAdonis)

# Function that allows for 3D NMDS plots
library(vegan3d)

#Makes grided figures
library(cowplot)

#Makes the sig bars
library(ggsignif)

#Mixed models

library(lme4)
library(lmerTest)
library(MuMIn)

library(rstatix)

library(ggpubr)

library(BiodiversityR)

library(ggrepel)
```


### Import Datasets {.tabset}

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

## Import Datasets

## inner (1 m^2) cover for Summer
#### comprehensive vegetative cover (%) for all species in the inner (1 m^2) permanent sampling area. 

inner_cover_summer_2022 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Cover/PE_Cover_Inner_Summer_2022_Cleaned.xlsx")

inner_cover_summer_2023 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Cover/PE_Cover_Inner_Summer_2023_Cleaned.xlsx")

## inner (1 m^2) cover for Fall
#### comprehensive vegetative cover (%) for all species in the inner (1 m^2) permanent sampling area. 


inner_cover_fall_2021 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Cover/PE_Cover_Inner_Fall_2021_Cleaned.xlsx")

inner_cover_fall_2022 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Cover/PE_Cover_Inner_Fall_2022_Cleaned.xlsx")

inner_cover_fall_2023 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Cover/PE_Cover_Inner_Fall_2023_Cleaned.xlsx")


## Bradford weather
weather <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Environment/Bradford_10_Year_Weather.xlsx")


## Light

light_fall_2022 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Environment/Priority_Effects_Fall_2022_Light.xlsx")

light_fall_2023 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Environment/Priority_Effects_Fall_2023_Light.xlsx")


## Bare and litter - 2021

bare_cover_2021 <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Cover/PE_Bare_Ground_Cleaned_2021.xlsx")


## Species list

species_list_PE <- read_excel("~/Priority-Effects/Priority Effects - Github/Data/Species_List.xlsx")
```


### Dataset cleaning {.tabset}


#### 2021 


```{r}

### Remove unnecessary columns

#### Get rid of the notes, unknown, and senensced columns

### Fall
inner_cover_fall_2021 <- inner_cover_fall_2021[,-c(6,7,8)]


#### change log
 # - senesced PLASPP changed to PLAVIR since PLALAN and PLAMAJ do not senesce until Oct.  (Sep 6, 2023)
 # - JUNSPP changed to JUNINT since JUNINT has been observed in 2022 and 2023 (Sep 6, 2023)


### Get rid of EMP

### Fall
inner_cover_fall_2021 <- subset(inner_cover_fall_2021, Treatment != "EMP")


```


#### 2022

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

## 2022 Inner Cover - Dataset cleaning

### Remove unnecessary columns

### Get rid of the notes, unknown, and sentenced columns

#### Summer
inner_cover_summer_2022 <- inner_cover_summer_2022[,-8]

#### change log
 # - Fixed IDs: most GALAPA -> GALPED and HEURIC -> GEUCAN (Sep 6, 2023)


#### Fall
inner_cover_fall_2022 <- inner_cover_fall_2022[,-c(8,9,10)]

#### change log
 # - Fixed IDs: VERSPP -> VERARV since this is the species observed in the summer (Sep 6, 2023)



### Get rid of EMP 

#### Summer
inner_cover_summer_2022 <- subset(inner_cover_summer_2022, Treatment != "EMP")

#### Fall
inner_cover_fall_2022 <- subset(inner_cover_fall_2022, Treatment != "EMP")
```



#### 2023

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

## 2023 Inner Cover - Dataset cleaning

### Remove unnecessary columns

### Get rid of the notes, unknown, and sentenced columns

#### Summer
inner_cover_summer_2023 <- inner_cover_summer_2023[,-c(6,7)]

#### change log
 # - Fixed IDs: was able to ID ALLSPP as ALLVIN (Sep 6, 2023)


#### Fall
inner_cover_fall_2023 <- inner_cover_fall_2023[,-c(6,7)]


### Get rid of EMP 

#### Summer
inner_cover_summer_2023 <- subset(inner_cover_summer_2023, Treatment != "EMP")

#### Fall
inner_cover_fall_2023 <- subset(inner_cover_fall_2023, Treatment != "EMP")
```



```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#Checking to make sure all the SPP6 levels are correct (no misspellings or weirdness)

### Fall 2021
sort(unique(inner_cover_fall_2021$SPP6))

### Summer 2022
sort(unique(inner_cover_summer_2022$SPP6))

### Fall 2022
sort(unique(inner_cover_fall_2022$SPP6))

### Summer 2023
sort(unique(inner_cover_summer_2023$SPP6))

### Fall 2023
sort(unique(inner_cover_fall_2023$SPP6))

### ^ above looks good so far

```

```{r}
# Make a unique identifier for year and season

### 2021

#### Season
inner_cover_fall_2021$Season <- rep("Fall", nrow=(inner_cover_fall_2021))
#### Year
inner_cover_fall_2021$Year <- rep("2021", nrow=(inner_cover_fall_2021))


### 2022

# Already has the identifiers
inner_cover_fall_2022$Year <- as.factor(inner_cover_fall_2022$Year)
inner_cover_summer_2022$Year <- as.factor(inner_cover_summer_2022$Year)

### 2023

#### Season
inner_cover_summer_2023$Season <- rep("Summer", nrow=(inner_cover_summer_2023))
inner_cover_fall_2023$Season <- rep("Fall", nrow=(inner_cover_fall_2023))

#### Year
inner_cover_fall_2023$Year <- rep("2023", nrow=(inner_cover_fall_2023))
inner_cover_fall_2023$Year <- as.factor(inner_cover_fall_2023$Year)

inner_cover_summer_2023$Year <- rep("2023", nrow=(inner_cover_summer_2023))
inner_cover_summer_2023$Year <- as.factor(inner_cover_summer_2023$Year)
```

```{r}
# Join years together

full_2021_data <- inner_cover_fall_2021

full_2022_data <- full_join(inner_cover_summer_2022,inner_cover_fall_2022)

full_2023_data <- full_join(inner_cover_summer_2023,inner_cover_fall_2023)


# Join all years together

### First 2021 and 2022
full_21_22_data <- full_join(full_2021_data, full_2022_data)

### Then 2021 and 2022 with 2023
full_year_data <- full_join(full_21_22_data, full_2023_data)

```

```{r}
# lump certain taxa together 

### Lump the Carex for now (*****Ask Lauren about what to do about when the CARSPP > CARFRA or CARBRE?***)

## MELOFF + MELALB -> MELSPP
## LEPVIR -> LEPSPP
## CARFRA -> CARSPP
## CARBRE -> CARSPP

for(i in 1:nrow(full_year_data)) {
  if(full_year_data[i,3] == "CARFRA"){full_year_data [i,3] <- "CARSPP"}
  if(full_year_data[i,3] == "CARBRE"){full_year_data [i,3] <- "CARSPP"}
  if(full_year_data[i,3] == "MELOFF"){full_year_data [i,3] <- "MELSPP"}
  if(full_year_data[i,3] == "MELALB"){full_year_data [i,3] <- "MELSPP"}
  if(full_year_data[i,3] == "LEPSPP"){full_year_data [i,3] <- "LEPVIR"}
  if(full_year_data[i,3] == "ECHSPP"){full_year_data [i,3] <- "ECHCRU"}
  
  # Make all cover data that was less than 1 = to 1 (to make the data discrete)
  if(full_year_data[i,4] < 1) {full_year_data [i,4] <- 1}
  
}

```

```{r}
inner_cover_max <- full_year_data  %>%
      group_by(Block, Treatment, Year, SPP6) %>%
      summarise(max_cover=max(Percent_Cover))

##### Note I manually checked species that were found in both the datasets (ACHMIL, TRIREP, CORLAN) and confirmed that the code above took the highest cover value for a species seen twice


### Remove Bare
inner_cover_max_only <- subset(inner_cover_max, SPP6 != "BARE")
### Remove Litter
inner_cover_max_only  <- subset(inner_cover_max_only, SPP6 != "LITTER")

head(inner_cover_max_only) 
```

### Bare/Litter

```{r}

### Bare dataset

inner_bare_cover <- subset(inner_cover_max, SPP6 == "BARE")

### Litter dataset

inner_litter_cover <- subset(inner_cover_max, SPP6 == "LITTER")


### Manipulate 2021 dataset to match 2022 and 2023

#### Bare Ground

bare_2021 <- subset(bare_cover_2021, Cover_Type != "Litter")
bare_2021 <- subset(bare_2021, Treatment != "EMP")
names(bare_2021) <- c("Block", "Treatment", "SPP6", "max_cover")
bare_2021$Year <- rep("2021", nrow(bare_2021))

for(i in 1:nrow(bare_2021)) {
  if(bare_2021[i,3] == "Bare"){bare_2021[i,3] <- "BARE"}
}

#### Litter 

litter_2021 <- subset(bare_cover_2021 , Cover_Type != "Bare")
litter_2021 <- subset(litter_2021, Treatment != "EMP")
names(litter_2021) <- c("Block", "Treatment", "SPP6", "max_cover")
litter_2021$Year <- rep("2021", nrow(litter_2021))


for(i in 1:nrow(litter_2021)) {
  if(bare_2021[i,3] == "Litter"){bare_2021[i,3] <- "LITTER"}
}


### Full_join datasets

inner_bare_cover <- full_join(inner_bare_cover, bare_2021)

inner_litter_cover <- full_join(inner_litter_cover, litter_2021)


```



```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#Checking again to make sure all the SPP6 levels are correct (no misspellings or weirdness)
sort(unique(inner_cover_max_only$SPP6))

SPP6_list <- sort(unique(inner_cover_max_only$SPP6))
SPP6_list <- as.data.frame(SPP6_list)

### Saw at least 94 different species across study
#### More since I had to lump MELOFF, MELALB, CARFRA, and CARBRE

# write_xlsx(SPP6_list, "Species_List2.xlsx")
```


```{r}

### Add species information to the dataset

#### N/A is N = native, A = non-native, G = Genus

inner_cover_max_only <- full_join(inner_cover_max_only, species_list_PE)

```

```{r}
#Remove unnecessary columns
inner_cover_max_reduced <- inner_cover_max_only[, -c(6,7,10)]

```


## Exploratory Analysis of Diversity {.tabset}


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

### Making a summary table of diversity indices between treatments

#Make a unique identifier for every block and treatment
inner_cover_max_reduced$UniqueBlock <- paste(inner_cover_max_reduced$Treatment, inner_cover_max_reduced$Block, sep="_")
```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}


### Making a community matrix

inner_cover_max_reduced_lumped <- inner_cover_max_reduced %>% 
  filter(Year != "2021") %>% 
  group_by(Block, Treatment, Year, SPP6) %>% 
  summarise(max_cover = sum(max_cover))


#Make a wide formatted dataset
inner_wide <- inner_cover_max_reduced_lumped  %>% 
  spread(key="SPP6", value="max_cover") 

#Replace NA values with 0

inner_wide[is.na(inner_wide)] <- 0 

#Make a separate dataframe for the labels
inner_wide.labs <- inner_wide[, c(1,2,3)]

#Turn our dataset into a matrix 
inner_wide_mat <- inner_wide[,-c(1,2,3)]


#Double check your work using the View() function. 

#View(inner_wide_mat)

```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

# Species richness


Species_richness <- specnumber(inner_wide_mat)
Species_richness

```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}


# Shannon's Diversity

#Calculate Shannon's Diversity
Shannon <- diversity(inner_wide_mat, index="shannon")

Shannon

```



```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

# Mean C


# Make a dataset that has each treatment, the species found in that treatment, and their associated C values

inner_cover_max_reduced$C_Value <- as.numeric(inner_cover_max_reduced$C_Value)

C_hist <- inner_cover_max_reduced  %>% 
                  filter( C_Value >= 0) %>% 
                  group_by(Block, Treatment, SPP6, Year, C_Value) %>% 
            summarize(tot.cover = sum(max_cover)) %>% 
            select(-c(tot.cover))
```



```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

# Calculate mean C for each Treatment in a Block
### Remember you have to filter out anything that isn't native!
Only_C <- inner_cover_max_reduced  %>% 
                  filter(Year != "2021") %>% 
                  filter( C_Value >= 0) %>% 
                  filter( C_Value != "NA") 

Only_C$C_Value <- as.numeric(Only_C$C_Value)

Mean_C <- Only_C %>% 
                  group_by(Block, Treatment, Year) %>% 
                  summarize(Mean_C = mean(C_Value))
```


### Summary Table of Diversity Indices

```{r, r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
Summary_table <- data.frame(Mean_C$Treatment, Mean_C$Block, Mean_C$Year, Species_richness, Shannon, Mean_C$Mean_C)

# Summary table for the Mean C, Species Richness, and Shannon's diversity for each block, treatment, and year combination

Summary_table <- Summary_table %>% 
  rename(Treatment = Mean_C.Treatment, Block = Mean_C.Block, Year = Mean_C.Year, Mean_C = Mean_C.Mean_C)



```

Below is a summary table showing the mean and SD for mean C value (C), species richness (SR), and Shannon diversity index (SDI) for each seeding treatment.

```{r, echo = FALSE, message = FALSE}
# Summary table for the mean and standard deviation for C values, Species Richness, and Shannon's diversity for each treatment overall

Summary_table_mean <- Summary_table %>% 
  group_by(Treatment, Year) %>%   
  summarise(Mean_C_t = mean(Mean_C), SD_C = sd(Mean_C), mean_richness = mean(Species_richness), SD_richness = sd(Species_richness), mean_Shannon = mean(Shannon), SD_Shannon = sd(Shannon))
  
Summary_table_mean <- Summary_table_mean %>% 
rename(Treatment = Treatment, "C_Mean" = Mean_C_t, "C_SD" = SD_C, "SR_Mean" = mean_richness,"SR_SD" = SD_richness, "SDI_Mean" = mean_Shannon, "SDI_SD" = SD_Shannon )

```

### Analyzing diversity

### Mean C 


##### Mean C - Model assumptions

Distribution of C values for all treatments were right skewed, indicating the majority of native plants in all treatments were of low conservatism value. SIM had the most "even" distribution of C values and almost every value was represented in this treatment. 

```{r, echo = FALSE}
# Make a histogram showing the distribution of c values in each treatment

ggplot(data = C_hist, aes(x= C_Value, fill = Year)) +geom_density(bins =30, alpha =0.4) +facet_wrap(~Treatment) + scale_x_continuous(breaks = seq(0, 10, 1))
```

```{r}

# A couple of outliers in the NAT treatment but likely alright since the variablity in outcomes seems to be a characteristic of NAT

# only one extreme value in LE 2021 (likely because of DALCAN and VIOPED)
Summary_table %>%
  group_by(Treatment, Year) %>%
  identify_outliers(Mean_C)


# Mean C fits a normal distribution

Summary_table  %>%
  group_by(Treatment, Year) %>%
  shapiro_test(Mean_C)

ggplot(data = Summary_table , aes(x= Mean_C)) +geom_histogram(bins =15) 


# Vast majority of points fall along the reference line

ggqqplot(Summary_table , "Mean_C", ggtheme = theme_bw()) +
  facet_grid(Year~ Treatment, labeller = "label_both")


```

##### Mean C - Model fitting


Mean C values were significantly higher in all treatments compared to the NON treatment. 

```{r}
#Dropped the mixed model due to singular fit -> the variance of the random effect block is estimated close to zero and does not further inform the data. 

Summary_table$Block <- as.factor(Summary_table$Block)

# Normal interaction model

#Mean_C.mod.lmer.interaction <- lmer(Mean_C~Treatment*Year+(1|Block), data =Summary_table)
#AIC(Mean_C.mod.lmer.interaction)


# Normal - additive model (has the lowest AIC)


Mean_C.mod.lm.additive <- lm(Mean_C~Treatment+Year, data =Summary_table)

## Summary results
summary(Mean_C.mod.lm.additive)

## AIC test
AIC(Mean_C.mod.lm.additive)

## ANOVA type 3
anova(Mean_C.mod.lm.additive)


## I removed the random effect block because it had no effect on the model fit and explained no additional variance. (chose the most parsimonius model)

# r.squaredGLMM(Mean_C.mod.lmer.additive)


## Inclusion of the random effect marginally increased model fit 



est.lm.treatment <- emmeans::emmeans(Mean_C.mod.lm.additive, "Treatment")


#Posthoc test

## Treatment
pairs(est.lm.treatment, adjust = "tukey")


```


```{r}
# Residual plot looks decent
plot(Mean_C.mod.lm.additive)

```

##### Mean C -  Figures


```{r}
Summary_table_mean$Treatment <- factor(Summary_table_mean$Treatment, levels=c("NON", "NAT", "LE", "LL", "SIM"))

lower.c <- Summary_table_mean$C_Mean - Summary_table_mean$C_SD
upper.c <- Summary_table_mean$C_Mean + Summary_table_mean$C_SD

pd <- position_dodge(width = 0.8)

C.plot <- ggplot(data = Summary_table_mean, aes(x = Year, y = C_Mean, color = Treatment))+
  geom_point(data = Summary_table_mean, size = 3, aes(shape = Treatment, fill = Treatment), position = pd)+
  geom_errorbar(aes(ymin = lower.c , ymax = upper.c), width = 0.5, position = pd) +
  labs(y = "Mean C", x = "Year" )+
  theme_classic() +
  theme(text=element_text(size=16), legend.key.size=unit(1, "cm"), legend.position="none")+
  scale_color_manual(name = "Treatment", values=c("#E69F00", "#F0E442",  "#009E73", "#56B4E9", "#0072B2"),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
  scale_fill_manual(name = "Treatment", values=c("#E69F00", "#F0E442",  "#009E73", "#56B4E9", "#0072B2"),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
   scale_shape_manual(name = "Treatment", values=c(21, 22,23, 24, 25),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))

C.plot
```


### Species Richness


SIM treatments had the greatest species richness compared to all other treatments, while NON and NAT had the lowest. 

##### SR - Model assumptions

```{r}

# A couple of outliers in the NAT treatment but likely alright since the variablity in outcomes seems to be a characteristic of NAT

Summary_table %>%
  group_by(Treatment, Year) %>%
  identify_outliers(Species_richness)


# Species richness fits a normal distribution

Summary_table %>%
  group_by(Treatment, Year) %>%
  shapiro_test(Species_richness)

ggplot(data = Summary_table, aes(x= Species_richness)) +geom_histogram(bins =15) 


# Vast majority of points fall along the reference line

ggqqplot(Summary_table, "Species_richness", ggtheme = theme_bw()) +
  facet_grid(Year~ Treatment, labeller = "label_both")


```


##### SR - Model fitting

```{r}
# Model Fitting

## Despite being count data, the distribution of Species richness is remarkabley balanced and not skewed. Model comparison using AIC reveals that the Normal model works better than the Poisson model. Model results also differ likely because of under dispersion. The more complicated Quasipoisson model that accounts for under dispersion produces similar results to the Normal mixed model. Therefore, I'm going to go with the less complicated Normal model.


SR.mod.normal <- lmer(Species_richness~Treatment+Year+(1|Block), data =Summary_table)
summary(SR.mod.normal)


## Treatment and Year significant
## Interaction between Treatment and Year not significant

anova(SR.mod.normal, type = 3)


## Marginal R^2 (variance explained by ONLY fixed effects) = 0.4547589
## Conditional R^2 (variance explained by the entire model) = 0.5554578

## Inclusion of the random effect increased model fit 


r.squaredGLMM(SR.mod.normal)

#Posthoc test

est.lmer.SR.treatment <- emmeans::emmeans(SR.mod.normal, "Treatment")


## Treatment
pairs(est.lmer.SR.treatment , adjust = "tukey")


```

```{R}
# Poisson Model

# SR.mod.pois <- glmer(Species_richness~Treatment+Year+(1|Block),family = "poisson", data =Summary_table)
# summary(SR.mod.pois)
# Anova(SR.mod.pois, type = 3)

# Check dispersion

## Underdispersed! 0.659 
## Interaction between treatment and year are not significant

# Dispersion_glmer(SR.mod.pois)


# Not accounting for the underdispersion mattered a lot! .

## Used a quassipoisson model instead and year is significant

#m6 <-glmmPQL(Species_richness~Treatment+Year,
             # random = ~ 1 | Block,
             # family = quasipoisson(link='log'), 
             # data = Summary_table)

# summary(m6)
# Anova(m6, type = 3)

```


```{r}

# Residual plot looks decent except for one large outlier
plot(SR.mod.normal)

```


##### SR - Figures

```{r}
Summary_table_mean$Treatment <- factor(Summary_table_mean$Treatment, levels=c("NON", "NAT", "LE", "LL", "SIM"))

lower.SR.c <- Summary_table_mean$SR_Mean - Summary_table_mean$SR_SD
upper.SR.c <- Summary_table_mean$SR_Mean + Summary_table_mean$SR_SD

pd <- position_dodge(width = 0.8)

SR.plot1 <- ggplot(data = Summary_table_mean, aes(x = Year, y = SR_Mean, color = Treatment))+
  geom_point(data = Summary_table_mean, size = 3, aes(shape = Treatment, fill = Treatment), position = pd)+
  geom_errorbar(aes(ymin = lower.SR.c , ymax = upper.SR.c), width = 0.5, position = pd) +
  labs(y = "Total Species Richness", x = "Year" )+
  theme_classic() +
  ylim(10,30)+
  theme(text=element_text(size=16), legend.key.size=unit(1, "cm"))+
  scale_color_manual(name = "Treatment", values=c("#E69F00", "#F0E442",  "#009E73", "#56B4E9", "#0072B2"),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
  scale_fill_manual(name = "Treatment", values=c("#E69F00", "#F0E442",  "#009E73", "#56B4E9", "#0072B2"),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
   scale_shape_manual(name = "Treatment", values=c(21, 22,23, 24, 25),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
    theme(legend.position="bottom")

SR.plot <- SR.plot1 +
    theme(legend.position="none")


leg <- get_legend(SR.plot1)
```



### Shannon Diversity Index

##### SDI - Model assumptions

SIM and LL treatments had the greatest Shannon diversity index value while NON had the lowest. NAT and LE appear comparable. 


```{r}


# Two extreme outliers (one in NAT 2021 and another in SIM 2021)
Summary_table %>%
  group_by(Treatment, Year) %>%
  identify_outliers(Shannon)


# Except for one point, Shannon diversity fits a normal distribution

Summary_table %>%
  group_by(Treatment, Year) %>%
  shapiro_test(Shannon)

ggplot(data = Summary_table, aes(x= Shannon)) +geom_histogram(bins =15) 


# Vast majority of points fall along the reference line

ggqqplot(Summary_table, "Shannon", ggtheme = theme_bw()) +
  facet_grid(Year~ Treatment, labeller = "label_both")


```

##### SDI - Model fitting

```{r}
Shannon.lmer.mod <- lmer(Shannon~Treatment+Year+(1|Block), data =Summary_table)
summary(Shannon.lmer.mod)
anova(Shannon.lmer.mod, type = 3)

# No significant interaction between treatment and year



## Marginal R^2 (variance explained by ONLY fixed effects) = 0.330704
## Conditional R^2 (variance explained by the entire model) = 0.3844412

## Inclusion of the random effect increased model fit 

r.squaredGLMM(Shannon.lmer.mod)



# Post-Hoc comparison

pairs(emmeans::emmeans(Shannon.lmer.mod, "Treatment"))





```



```{r}

# A little heteroscedastic (bowtie shaped but probably ok)
plot(Shannon.lmer.mod)

```

##### SDI - Figures

```{r}
Summary_table_mean$Treatment <- factor(Summary_table_mean$Treatment, levels=c("NON", "NAT", "LE", "LL", "SIM"))

lower.SDI.c <- Summary_table_mean$SDI_Mean - Summary_table_mean$SDI_SD
upper.SDI.c <- Summary_table_mean$SDI_Mean + Summary_table_mean$SDI_SD

pd <- position_dodge(width = 0.8)

SDI.plot <- ggplot(data = Summary_table_mean, aes(x = Year, y = SDI_Mean, color = Treatment))+
  geom_point(data =Summary_table_mean, size = 3, aes(shape = Treatment, fill = Treatment), position = pd)+
  geom_errorbar(aes(ymin = lower.SDI.c , ymax = upper.SDI.c), width = 0.5, position = pd) +
  labs(y = "SDI", x = "Year" )+
  theme_classic() +
  theme(text=element_text(size=16), legend.key.size=unit(1, "cm"), legend.position="none")+
  scale_color_manual(name = "Treatment", values=c("#E69F00", "#F0E442",  "#009E73", "#56B4E9", "#0072B2"),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
  scale_fill_manual(name = "Treatment", values=c("#E69F00", "#F0E442",  "#009E73", "#56B4E9", "#0072B2"),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))+
   scale_shape_manual(name = "Treatment", values=c(21, 22,23, 24, 25),   breaks=c("NON", "NAT", "LE", "LL", "SIM"), labels = c("NON", "NAT", "LE", "LL", "SIM"))

SDI.plot 
```


### Plot Panel

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width = 12, fig.height = 4}

diversity_panel <- ggarrange(C.plot, SR.plot, SDI.plot,
align='h', labels=c('A', 'B','C'), ncol = 3,
common.legend = T, legend = "bottom")

diversity_panel
```



## Comparing seeded cover (in the inner 1 m^2 sampling area) for each treatment {.tabset}


**note** some of the species used in the seed mix were present in the seed bank at my study site (e.g., RUDHIR and PENDIG). Additionally, some spillover occurred with seeded species seeding into other treatments like NON (e.g., BIDARI)

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
#inner_wide is the community matrix
#inner_wide.labs has the labels

inner_long <- inner_wide %>% 
  gather(key = "SPP6", value = "max_cover", ACAVIR:VIOPED) 

```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
Seeded <- inner_long  %>% 
  filter(Treatment %in% c("LE", "NAT", "LL", "SIM", "NON")) %>% 
  filter(SPP6 %in% c("ACHMIL","CORLAN", "LOBSPI","TRAOHI", "LINSUL", "CORPAL", "AMOCAN", "DALCAN", "DALPUR", "SPHOBT", "CARBUS", "KOEMAC",  "HEURIC", "VIOPED", "SISCAM", "DODMEA", "MELVIR", "PACPLA", "LESCAP","MONFIS", "BIDARI","SORNUT", "SCHSCO", "HYPPUN", "SPOHET", "HELMOL", "RATPIN", "SOLRIG", "PENDIG", "CHAFAS",  "ERYYUC", "CORTRI", "PYCTEN", "CROSAG", "RUDHIR", "LIAPYC"))


Non_Seeded <- inner_long  %>% 
  filter(Treatment %in% c("LE", "NAT", "LL", "SIM", "NON")) %>% 
  filter(!SPP6 %in% c("ACHMIL","CORLAN", "LOBSPI","TRAOHI", "LINSUL", "CORPAL", "AMOCAN", "DALCAN", "DALPUR", "SPHOBT", "CARBUS", "KOEMAC",  "HEURIC", "VIOPED", "SISCAM", "DODMEA", "MELVIR", "PACPLA", "LESCAP","MONFIS", "BIDARI","SORNUT", "SCHSCO", "HYPPUN", "SPOHET", "HELMOL", "RATPIN", "SOLRIG", "PENDIG", "CHAFAS",  "ERYYUC", "CORTRI", "PYCTEN", "CROSAG", "RUDHIR", "LIAPYC"))
```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#Sum the total cover of seeded species per treatment.block 
Seeded_Tot <- Seeded %>% 
  filter(Treatment != "NON") %>% 
  group_by(Treatment, Block, Year) %>% 
  summarise(seeded_cover = sum(max_cover))

# Sum the total cover observed at a treatment, block, and year

Cover_Tot <- inner_long %>% 
  filter(Treatment != "NON") %>% 
  group_by(Treatment, Block, Year) %>% 
  summarise(tot_cover = sum(max_cover))

# Join the two dataset together

Total_Cover_Tot <- full_join(Seeded_Tot, Cover_Tot)

Total_Cover_Tot$Seeded_prop <- Total_Cover_Tot$seeded_cover / Total_Cover_Tot$tot_cover 

#Take the mean cover for each treatment
Seeded_Mean <- Total_Cover_Tot %>% 
  group_by(Treatment, Year) %>% 
  summarise(Mean_seeded_prop = mean(Seeded_prop), SD = sd(Seeded_prop))

```


### Total Seeded Cover


#### TSC - Model fitting

```{r, echo = FALSE, message = FALSE, warning = FALSE}

## I removed the random effect block because it had no effect on the model fit and explained no additional variance. (chose the most parsimonius model)

# no interaction between year and treatment 
# Random effect does not increase the amount of variance explained and results in singular fit

Binom_mod <- glm(cbind(seeded_cover, tot_cover) ~ Treatment*Year, family = binomial, data = Total_Cover_Tot)

summary(Binom_mod)
Anova(Binom_mod, type = 3)

pairs(emmeans::emmeans(Binom_mod , ~ Treatment*Year, type = "response"))
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
plot(Binom_mod)
```


#### TSC - Figures

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#Re-order the levels
Seeded_Mean$Treatment <- factor(Seeded_Mean$Treatment, levels=c("NAT", "LE", "LL", "SIM"))

total.cover.plot <- ggplot(data = Seeded_Mean, aes(x = Year,  y = Mean_seeded_prop, fill = Treatment))+
  geom_bar(position = position_dodge(preserve = "single"), stat = "identity", color = "black", show.legend = TRUE)+
  geom_errorbar(position =  position_dodge(width = 0.9, preserve = "single"), aes(x = Year, ymax=Mean_seeded_prop+SD, ymin = Mean_seeded_prop))+
  scale_fill_manual(name = "Treatment", values=c("#F0E442",  "#009E73", "#56B4E9", "#0072B2"))+
  labs(x = "Year", y = "Prop. seeded cover")+
  theme_minimal()+
  theme()+ 
  scale_y_continuous(breaks=seq(0,.70,by=0.1), limits = c(0,.7))+
  theme_classic() +
  theme(text=element_text(size=14))

total.cover.plot 

```

### Early season seeded cover

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

Seeded_early <- inner_long  %>% 
  filter(Treatment != "NON") %>% 
  filter(SPP6 %in% c("ACHMIL","CORLAN", "LOBSPI","TRAOHI", "LINSUL", "CORPAL", "AMOCAN", "DALCAN", "DALPUR", "SPHOBT", "CARBUS", "KOEMAC",  "HEURIC", "VIOPED", "SISCAM", "DODMEA", "MELVIR", "PACPLA"))
```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
Seeded_early_all <- Seeded_early %>% 
  group_by(Treatment, Year, Block) %>% 
  summarise(seeded_cover = sum(max_cover))


# Join the two dataset together

Total_Cover_Early <- full_join(Seeded_early_all, Cover_Tot)

Total_Cover_Early$Seeded_prop <-Total_Cover_Early$seeded_cover / Total_Cover_Early$tot_cover

Seeded_early_all_mean <- Total_Cover_Early %>% 
  filter(Treatment != "NON") %>% 
  group_by(Treatment, Year) %>% 
  summarise(Mean_cover = mean(Seeded_prop), SD = sd(Seeded_prop)) 
```



#### ESC - Model fitting


```{r, echo = FALSE, message = FALSE, warning = FALSE}

## I removed the random effect block because it had no effect on the model fit and explained no additional variance. (chose the most parsimonius model)

# no interaction between year and treatment 
# Random effect does not increase the amount of variance explained and results in singular fit

Binom_mod_early <- glm(cbind(seeded_cover, tot_cover) ~ Treatment+Year, family = binomial, data = Total_Cover_Early)

summary(Binom_mod_early)
Anova(Binom_mod_early, type = 3)

pairs(emmeans::emmeans(Binom_mod_early, ~ Treatment, type = "response"))
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
plot(Binom_mod_early)
```


#### ESC - Figures

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
#Re-order the levels
Seeded_early_all_mean$Treatment <- factor(Seeded_early_all_mean$Treatment, levels=c( "NAT", "LE", "LL", "SIM"))

early.cover.plot <-ggplot(data = Seeded_early_all_mean, aes(x = Year,  y = Mean_cover, fill = Treatment))+
  geom_bar(position = position_dodge(preserve = "single"), stat = "identity", color = "black", show.legend =  TRUE)+
  geom_errorbar(position =  position_dodge(width = 0.9, preserve = "single"), aes(x = Year, ymax=Mean_cover+SD, ymin = Mean_cover))+
  scale_fill_manual(name = "Treatment", values=c("#F0E442",  "#009E73", "#56B4E9", "#0072B2"))+
  labs(x = "Year", y = "Prop. seeded early cover")+
  theme_minimal()+
  theme(axis.text=element_text(size=16), axis.title = element_text(size = 12))+ 
  scale_y_continuous(breaks=seq(0, 0.7 ,by=.1), limits = c(0,0.7))+
  theme(legend.position = "none")+
  theme_classic() +
  theme(text=element_text(size=14))
  
early.cover.plot
```


### Fall dispersing species only

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

Seeded_late <- inner_long  %>% 
  filter(Treatment %in% c("LE", "NAT", "LL", "SIM")) %>% 
  filter(SPP6 %in% c("LESCAP","MONFIS", "BIDARI","SORNUT", "SCHSCO", "HYPPUN", "SPOHET", "HELMOL", "RATPIN", "SOLRIG", "PENDIG", "CHAFAS",  "ERYYUC", "CORTRI", "PYCTEN", "CROSAG", "RUDHIR", "LIAPYC"))
```



```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}


Seeded_late_all <- Seeded_late %>% 
  group_by(Treatment, Year, Block) %>% 
  summarise(seeded_cover = sum(max_cover)) 

# Join the two dataset together

Total_Cover_Late <- full_join(Seeded_late_all, Cover_Tot)

Total_Cover_Late$Seeded_prop <-Total_Cover_Late$seeded_cover / Total_Cover_Late$tot_cover

Seeded_late_all_mean <-Total_Cover_Late %>% 
  group_by(Treatment, Year) %>% 
  summarise(Mean_cover = mean(Seeded_prop), SD = sd(Seeded_prop)) 
```


#### LSC - Model fitting


```{r, echo = FALSE, message = FALSE, warning = FALSE}

## I removed the random effect block because it had no effect on the model fit and explained no additional variance. (chose the most parsimonius model)

# no interaction between year and treatment 
# Random effect does increase the amount of variance explained

Binom_mod_late <- glmer(cbind(seeded_cover, tot_cover) ~ Treatment+Year+(1|Block), family = binomial, data = Total_Cover_Late)

summary(Binom_mod_late)
Anova(Binom_mod_late, type = 3)

pairs(emmeans::emmeans(Binom_mod_late, ~ Treatment, type = "response"))
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
plot(Binom_mod_late)
```


#### LSC - Figures


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
#Re-order the levels
Seeded_late_all_mean$Treatment <- factor(Seeded_late_all_mean$Treatment, levels=c("NAT", "LE", "LL", "SIM"))

late.cover.plot <- ggplot(data = Seeded_late_all_mean, aes(x = Year,  y = Mean_cover, fill = Treatment))+
  geom_bar(position = position_dodge(preserve = "single"), stat = "identity", color = "black", show.legend = TRUE)+
  geom_errorbar(position =  position_dodge(width = 0.9, preserve = "single"), aes(x = Year, ymax=Mean_cover+SD, ymin = Mean_cover))+
  scale_fill_manual(name = "Treatment", values=c("#F0E442",  "#009E73", "#56B4E9", "#0072B2"))+
  labs(x = "Year", y = "Prop. seeded late cover")+
  theme(axis.text=element_text(size=16), axis.title = element_text(size = 12))+ 
  scale_y_continuous(breaks=seq(0, 0.7,by=.1), limits = c(0,0.7))+
  theme_classic() +
  theme(text=element_text(size=14))


late.cover.plot
```


### Plot Panel

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width = 12, fig.height = 4}

seeded_cover_panel <- ggarrange(total.cover.plot, early.cover.plot, late.cover.plot,
align='h', labels=c('A', 'B','C'), ncol = 3,
common.legend = T, legend = "right")

seeded_cover_panel
```


## Community Analysis {.tabset}

### RDA Ordination



### Year: 2022


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}


#Make a wide formatted dataset
inner_wide_2022 <- inner_cover_max_reduced_lumped  %>%
  filter(Year %in% 2022) %>% 
  spread(key="SPP6", value="max_cover") 

#Replace NA values with 0

inner_wide_2022[is.na(inner_wide_2022)] <- 0 

#Turn our dataset into a matrix 
inner_wide_mat_2022 <- inner_wide_2022[,-c(1,2,3)]


# labels
inner_wide_labels_2022 <- inner_wide_2022[,c(1,2,3)]

# Standardize by max 

inner.max.2022 <- decostand(inner_wide_mat_2022, "max")


```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
dimcheckMDS(inner.max.2022, distance = "bray", k=6, trymax= 20, autotransform = FALSE)

```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#metaMDS for maximum standardization
#best solution converged several times at 3 dimensions

inner.cover.2022.mds <- metaMDS(inner.max.2022, distance = "bray", autotransform = FALSE, try = 100, k =3)
```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

### Looks at which species were the most influential in driving the observed patterns
inner.spp.fit.2022 <- envfit(inner.cover.2022.mds, inner.max.2022, permutations = 999, k =3)
#head(inner.spp.fit.2022)
```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}


#ordiplot3d(inner.cover.mds)
pl.2022 <- ordiplot3d(inner.cover.2022.mds, scaling = "symmetric", angle = 35, type="n")

### Plots the points and gives a unique shape based on year and unique color based on treatment
ordiellipse(pl.2022, groups = inner_wide_labels_2022$Treatment, label = F, draw = "polygon", lty = 1,col = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2"),  conf = 0.95, kind = "se")

# Draws 95% CI around the treatment groups (based on se)
points(pl.2022,"points", pch = c(21, 22, 23, 24, 25) [as.factor(inner_wide_labels_2022$Treatment)], bg = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2") [as.factor(inner_wide_labels_2022$Treatment)], cex =1)


### Legend so I can know what shapes and colors correspond to which groups
legend("topright", legend = c("LE", "LL", "NAT", "NON", "SIM"),  pch = c(21, 22, 23, 24, 25), pt.bg = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2"), bty = "n", cex = 1) 

### Displays the type of standardization, Stress, and Dimensions used
legend("topleft", c("Year: 2022", "Max Standardization", "Stress = 0.17", "K = 3"), bty = "n", cex = 0.75)

```


### Year: 2023

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width = 12, fig.height = 4}

#Make a wide formatted dataset
inner_wide_2023 <- inner_cover_max_reduced_lumped  %>%
  filter(Year %in% 2023) %>% 
  spread(key="SPP6", value="max_cover") 

#Replace NA values with 0

inner_wide_2023[is.na(inner_wide_2023)] <- 0 

#Turn our dataset into a matrix 
inner_wide_mat_2023 <- inner_wide_2023[,-c(1,2,3)]

# make new dataset for labels & envdata

## get the treatment labels
inner_wide_labels_2023 <- inner_wide_2023[,c(1,2,3)]

## Bare ground dataset
inner_bare_cover_2023 <- inner_bare_cover %>% 
  filter(Year == "2023") %>% 
   rename("Bare_cover" = "max_cover") %>% 
  select(-SPP6)

## Light dataset

light_2023 <- light_fall_2023 %>% 
  group_by(Block, Treatment, Location) %>% 
  summarize(Mean_Light = mean(Light)) %>% 
  spread(key = Location , value = Mean_Light)

## join

env.data.2023.bare <- full_join(inner_wide_labels_2023, inner_bare_cover_2023) 

env.data.2023 <- full_join(env.data.2023.bare, light_2023)

# Standardize by max 

inner.max.2023 <- decostand(inner_wide_mat_2023, "max")

```


```{r}
### fit a distance-based RDA 
#### Allows you to do a constrained ordination using non-Euclidean distance measures such as Bray-curtis dissimilarity (which is fitting for our data on plant communities)

#### it works by: 1) making the distance matrix based on your desired measure, 2) doing a PCoA, 3) taking the PCoA eigenvectors and putting them into an RDA.


### Use the capscale function (not the dbRDA since it doesn't provide species scores)
dbRDA <- capscale(inner.max.2023 ~ Treatment+Middle, data = env.data.2023,  dist="bray")

## dbRDA results
dbRDA

## PERMANOVA results
anova(dbRDA, step = 1000, by = "terms", permu = 200)
```

```{r}
### Get the basic ordination plot 

plot2 <- ordiplot(dbRDA, choices = c(1,2))
```

```{r}
### extract the site information

sites.long2 <- sites.long(plot2, env.data = env.data.2023)

head(sites.long2)

### extract the species information

species.long2 <- species.long(plot2)
species.long2

### extract the first two axis info

axis.long2 <- axis.long(dbRDA, choices = c(1,2))
axis.long2 
```

```{r}

### set a basic theme

BioR.theme <- theme(
panel.background = element_blank(),
panel.border = element_blank(),
panel.grid = element_blank(),
axis.line = element_line("gray25"),
text = element_text(size = 12, family="Arial"),
axis.text = element_text(size = 10, colour = "gray25"),
axis.title = element_text(size = 14, colour = "gray25"),
legend.title = element_text(size = 14),
legend.text = element_text(size = 14),
legend.key = element_blank())
```


```{r}
# Do an envfit to find influential speicies (p < 0.05)


spec.envfit <- envfit(plot2, env=inner.max.2023)
spec.data.envfit <- data.frame(r=spec.envfit$vectors$r, p=spec.envfit$vectors$pvals)
species.long2 <- species.long(plot2, spec.data=spec.data.envfit)
species.long2


species.long3 <- species.long2[species.long2$p < 0.05, ]
species.long3

# Join influential species dataframe to species list information so we can later color species labels by seeded status

species.long3 <- species.long3 %>% 
  rename(SPP6 = "labels")

species.long3 <- left_join(species.long3, species_list_PE, by = "SPP6")
```

```{r}
# Get the vector information for environmental variables

vectors.envfit <- envfit(plot2, env=env.data.2023)
vectors.long3 <- vectorfit.long(vectors.envfit)
vectors.long3

```

```{r}
# Get the ellipse information

Treatment.ellipses <- ordiellipse(plot2, groups=env.data.2023$Treatment, display="sites", kind="sd")
Treatment.ellipses.long2 <- ordiellipse.long(Treatment.ellipses, grouping.name="Treatment")
```

```{r, message = FALSE, echo = FALSE, warning = FALSE, fig.width = 10, fig.height = 10}

# Plot it!


dbRDA.2023.plot <- ggplot() + 
    geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
    geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +  
    xlab(axis.long2[1, "label"]) +
    ylab(axis.long2[2, "label"]) +  
    scale_x_continuous(sec.axis = dup_axis(labels=NULL, name=NULL)) +
    scale_y_continuous(sec.axis = dup_axis(labels=NULL, name=NULL)) +  
    scale_fill_manual(name = "Treatment", breaks = c("LE", "LL", "NAT", "NON", "SIM"),
                         labels = c("Summer first", "Fall first", "Natural", "No seeding", "Simultaneous"),
                         values = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2"))+
    scale_shape_manual(name = "Treatment", breaks = c("LE", "LL", "NAT", "NON", "SIM"),
                         labels = c("Summer first", "Fall first", "Natural", "No seeding", "Simultaneous"),
                         values = c(21, 22, 23, 24, 25))+
    geom_polygon(data=Treatment.ellipses.long2, 
                   aes(x=axis1, y=axis2, fill=Treatment, alpha = 0.1), 
              size=0.2, show.legend=FALSE) +
  geom_point(data=sites.long2, 
               aes(x=axis1, y=axis2, fill=Treatment, shape=Treatment), 
               size=4) +
  geom_segment(data=species.long3, 
                 aes(x=0, y=0, xend=axis1*4, yend=axis2*4), 
                 colour="grey0", size=0.7, alpha = 0.3) +
    geom_text_repel(data=species.long3, 
                    aes(x=axis1*4, y=axis2*4, colour=Seeded, label=SPP6), size = 3.2)+
  scale_color_manual(name = "Season", breaks = c("Fall", "Summer", "Unseeded"),
                         labels = c("Fall", "Summer", "Unseeded"),
                         values = c("darkblue", "darkgreen",  "#BE5504"))+
    geom_segment(data=subset(vectors.long3, vector %in% c("Middle")),
                 aes(x=0, y=0, xend=axis1*1, yend=axis2*1), 
                 colour="black", size=0.7) +
    geom_text_repel(data=subset(vectors.long3, vector %in% c("Middle")), 
                    aes(x=axis1*1, y=axis2*1, label=vector),
                    colour="black", size = 4.5) +
    BioR.theme  +
    coord_fixed(ratio=1)

dbRDA.2023.plot
```


### All

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

# Standardize by max 

inner.max <- decostand(inner_wide_mat, "max")
```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
# Check the stress at various dimensions using bray-curtis dissimilarity
## stress = 0.1718204 in 3 dimensions
## Stress was far too high in 2 dimensions - 

fig <- dimcheckMDS(inner.max, distance = "bray", k=6, trymax= 20, autotransform = FALSE)
```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
fig
```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#metaMDS for maximum standardization
#best solution converged several times at 3 dimensions

inner.cover.mds <- metaMDS(inner.max, distance = "bray", autotransform = FALSE, trymax =50, k =3)
```

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

#### Take the full inner cover dataset and only keep the labels (year, block, treatment, ID)
#### This will be useful in grouping points in the NMDS and running the PERMANOVA latter on


#joined_inner_cover_2022_data <- joined_inner_cover_2022 %>% 
  #group_by(UniqueBlock, Block, Treatment) %>% 
  #summarise(Percent_Cover = sum(max_cover)) %>% 
 # select(-Percent_Cover)

```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

### Looks at which species were the most influential in driving the observed patterns
inner.spp.fit <- envfit(inner.cover.mds, inner.max, permutations = 999, k =3)
#head(inner.spp.fit)
```


```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

inner_wide.labs$Treatment_Year <- paste(inner_wide.labs$Treatment, inner_wide.labs$Year, sep="_")

#ordiplot3d(inner.cover.mds)
pl <- ordiplot3d(inner.cover.mds, scaling = "symmetric", angle = 35, type="n")

### Plots the points and gives a unique shape based on year and unique color based on treatment
ordiellipse(pl, groups = inner_wide.labs$Treatment, label = F, draw = "polygon", lty = 1,col = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2"),  conf = 0.95, kind = "se")

# Draws 95% CI around the treatment groups (based on se)
points(pl,"points", pch = c(21, 22, 23, 24, 25) [as.factor(inner_wide.labs$Treatment)], bg = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2") [as.factor(inner_wide.labs$Treatment)], cex =1)


### Legend so I can know what shapes and colors correspond to which groups
legend("topright", legend = c("LE", "LL", "NAT", "NON", "SIM"),  pch = c(21, 22, 23, 24, 25), pt.bg = c("#009E73", "#56B4E9",  "#F0E442","#E69F00", "#0072B2"), bty = "n", cex = 1) 

### Displays the type of standardization, Stress, and Dimensions used
legend("topleft", c("Max Standardization", "Stress = 0.17", "K = 3"), bty = "n", cex = 1)

```


## PERMANOVA

PERMANOVA analysis revealed that treatment did have a significant effect on plant community composition. Treatment also explained ~ 20% of the variation in the plant community. Post-hoc analysis shows that LE, NON, and NAT treatments were not significantly different from each other but did differ in plant community composition compared to the SIM and LL seeding treatments.  Additionally, the SIM and LL treatments were only marginally different (p = 0.053). Based on the NMDS above, the LL plant community appears as a subset of the SIM plant community. Despite receiving the same pool of seeded species, species added to the plots later in the growing season did not establish as well. Barriers to establishment also appeared higher for spring/summer dispersing species compared to fall dispersing species, particularly when added without priority. 


```{r, echo = FALSE, message = FALSE, warning = FALSE}

### PERMANOVA analysis predicting the community based on year and treatment with block as a random effect
### At least on treatment sig. different from the others
### Not exactly sure how to specify the strata...? ***Ask Lauren***

inner_wide$Block <- as.factor(inner_wide$Block )

adonis2(inner.max ~ Treatment+Year, data=inner_wide, method = "bray", permutations=1000)


### Treatments
### LE != LL < 0.001
### LE != SIM < 0.001
### LL != NAT < 0.05
### LL != NON < 0.001
### NAT != SIM < 0.001
### NON != SIM < 0.001


pairwise.adonis2(inner.max  ~ Treatment+Year, method = "bray", data=inner_wide)

```


### Weather data

```{r}
# Precipitation



month_tot <- weather %>% 
  filter(Year != "2021") %>% 
  group_by(Month, Year) %>% 
  summarize(tot_month_PRP_mm = sum(Total_PRP_mm))

year_tot <- weather %>% 
  filter(Year != "2021") %>% 
  group_by(Year) %>% 
  summarize(tot_PRP_mm = sum(Total_PRP_mm))

library(mosaic)

favstats(year_tot$tot_PRP_mm)
```

```{r}
# Average air temperature


library(mosaic)

favstats(weather$Average_Air_Temp_C)
```



  